name: Release Versioned Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v1.1.2)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    runs-on: macos-latest

    steps:
      - name: Determine tag name
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          VERSION=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Tag: $TAG_NAME"
          echo "ðŸ“Œ Version: $VERSION"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_version.outputs.TAG_NAME }}
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ ERROR: VERSION file ($FILE_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi
          echo "âœ… Version verified"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run tests
        run: swift test

      - name: Build app
        run: |
          chmod +x Scripts/build-app.sh Scripts/inject-version.sh
          ./Scripts/build-app.sh

      - name: Create ZIP archive
        run: |
          ditto -c -k --keepParent ScreenshotRenamer.app ScreenshotRenamer.zip
          echo "ðŸ“¦ Created ScreenshotRenamer.zip"

      - name: Create DMG
        run: |
          hdiutil create -volname "Screenshot Renamer" \
            -srcfolder ScreenshotRenamer.app \
            -ov -format UDZO \
            ScreenshotRenamer.dmg
          echo "ðŸ’¿ Created ScreenshotRenamer.dmg"

      - name: Generate checksums
        run: |
          shasum -a 256 ScreenshotRenamer.zip > ScreenshotRenamer.zip.sha256
          shasum -a 256 ScreenshotRenamer.dmg > ScreenshotRenamer.dmg.sha256
          echo "âœ… Generated checksums"
          cat ScreenshotRenamer.zip.sha256
          cat ScreenshotRenamer.dmg.sha256

      - name: Generate changelog
        id: changelog
        run: |
          # Find the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ steps.get_version.outputs.TAG_NAME }}^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using all commits"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating changelog from $PREVIOUS_TAG to ${{ steps.get_version.outputs.TAG_NAME }}"

          # Get commits between tags
          COMMITS=$(git log $PREVIOUS_TAG..${{ steps.get_version.outputs.TAG_NAME }} --pretty=format:"- %s (%h)" --no-merges)

          # Create changelog file
          cat <<EOF > changelog.md
          ## What's Changed

          $COMMITS

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.get_version.outputs.TAG_NAME }}
          EOF

          echo "changelog_file=changelog.md" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          cat <<EOF > release_notes.md
          ## Screenshot Renamer v${{ steps.get_version.outputs.VERSION }}

          ### Installation

          **Option 1: DMG (Recommended)**
          1. Download \`ScreenshotRenamer.dmg\`
          2. Open the DMG file
          3. Drag the app to your Applications folder
          4. Right-click the app and select "Open" to bypass Gatekeeper

          **Option 2: ZIP**
          1. Download \`ScreenshotRenamer.zip\`
          2. Unzip the file
          3. Move \`ScreenshotRenamer.app\` to Applications
          4. Right-click the app and select "Open" to bypass Gatekeeper

          **Verify Download (Optional):**
          \`\`\`bash
          shasum -a 256 -c ScreenshotRenamer.zip.sha256
          # or
          shasum -a 256 -c ScreenshotRenamer.dmg.sha256
          \`\`\`

          ### Auto-Start on Login

          To have Screenshot Renamer start automatically when you log in:

          1. Open **System Settings** â†’ **General** â†’ **Login Items**
          2. Click the **+** button
          3. Select **Screenshot Renamer.app**

          ---

          $(cat changelog.md)
          EOF

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.get_version.outputs.TAG_NAME }} \
            --title "Screenshot Renamer v${{ steps.get_version.outputs.VERSION }}" \
            --notes-file release_notes.md \
            --latest \
            ScreenshotRenamer.zip \
            ScreenshotRenamer.zip.sha256 \
            ScreenshotRenamer.dmg \
            ScreenshotRenamer.dmg.sha256

      - name: Release summary
        run: |
          echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** Stable release" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts:** ZIP, DMG, and checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ [Download Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }})" >> $GITHUB_STEP_SUMMARY
