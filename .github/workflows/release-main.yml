name: Release Latest Build

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: get_version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run tests
        run: swift test

      - name: Build app
        run: |
          chmod +x Scripts/build-app.sh Scripts/inject-version.sh
          ./Scripts/build-app.sh

      - name: Create ZIP archive
        run: |
          ditto -c -k --keepParent ScreenshotRenamer.app ScreenshotRenamer.zip
          echo "ðŸ“¦ Created ScreenshotRenamer.zip"

      - name: Create DMG
        run: |
          hdiutil create -volname "Screenshot Renamer" \
            -srcfolder ScreenshotRenamer.app \
            -ov -format UDZO \
            ScreenshotRenamer.dmg
          echo "ðŸ’¿ Created ScreenshotRenamer.dmg"

      - name: Generate checksums
        run: |
          shasum -a 256 ScreenshotRenamer.zip > ScreenshotRenamer.zip.sha256
          shasum -a 256 ScreenshotRenamer.dmg > ScreenshotRenamer.dmg.sha256
          echo "âœ… Generated checksums"
          cat ScreenshotRenamer.zip.sha256
          cat ScreenshotRenamer.dmg.sha256

      - name: Create release notes
        id: release_notes
        run: |
          cat <<EOF > release_notes.md
          ## Screenshot Renamer v${{ steps.get_version.outputs.VERSION }} (Latest Build)

          This is the latest development build from the main branch.

          **âš ï¸ Note:** This is a pre-release build. For stable releases, see [Releases](https://github.com/${{ github.repository }}/releases).

          ### Installation

          **Option 1: DMG (Recommended)**
          1. Download \`ScreenshotRenamer.dmg\`
          2. Open the DMG file
          3. Drag the app to your Applications folder
          4. Right-click the app and select "Open" to bypass Gatekeeper

          **Option 2: ZIP**
          1. Download \`ScreenshotRenamer.zip\`
          2. Unzip the file
          3. Move \`ScreenshotRenamer.app\` to Applications
          4. Right-click the app and select "Open" to bypass Gatekeeper

          **Verify Download (Optional):**
          \`\`\`bash
          shasum -a 256 -c ScreenshotRenamer.zip.sha256
          # or
          shasum -a 256 -c ScreenshotRenamer.dmg.sha256
          \`\`\`

          ### Build Information

          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Built:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Workflow:** [${{ github.workflow }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### What's Changed

          See commit: [${{ github.event.head_commit.message }}](${{ github.event.head_commit.url }})

          ---

          For the latest stable release, visit [Releases](https://github.com/${{ github.repository }}/releases).
          EOF
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Delete existing 'latest' release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view latest &>/dev/null; then
            echo "ðŸ—‘ï¸ Deleting existing 'latest' release..."
            gh release delete latest --yes
          fi
          if git rev-parse latest &>/dev/null; then
            echo "ðŸ—‘ï¸ Deleting existing 'latest' tag..."
            git push origin :refs/tags/latest || true
          fi

      - name: Create 'latest' release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create latest \
            --title "Screenshot Renamer v${{ steps.get_version.outputs.VERSION }} (Latest Build)" \
            --notes-file release_notes.md \
            --prerelease \
            ScreenshotRenamer.zip \
            ScreenshotRenamer.zip.sha256 \
            ScreenshotRenamer.dmg \
            ScreenshotRenamer.dmg.sha256

      - name: Release summary
        run: |
          echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** Pre-release (development build)" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts:** ZIP, DMG, and checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ [Download Latest Build](https://github.com/${{ github.repository }}/releases/tag/latest)" >> $GITHUB_STEP_SUMMARY
